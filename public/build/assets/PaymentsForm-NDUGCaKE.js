import{r as f,j as s}from"./app-xOoa6HPd.js";import{I as b}from"./input-error-B3TWQCeb.js";import{I as j}from"./input-D3BiNtE6.js";import{L as c}from"./label-DJSHCchO.js";import{S as _}from"./react-select.esm-CA10u9P8.js";import R from"./ConsultationsTable-4xCxmHUf.js";import L from"./SubscriptionsTable-CEtb1XuW.js";import"./utils-bRKmu4jq.js";import"./index-DzIYgzR8.js";import"./index-DuDXMw8I.js";import"./floating-ui.dom-C5vApqfE.js";import"./table-CjD9jXok.js";import"./use-sync-refs-D_WD0X-d.js";function Z({data:t,patients:x=[],paymentMethods:k,consultations:v=[],initialSelectedConsultationIds:w=[],setData:i,errors:d}){var P,I;const T=(((P=t.consultation_ids)==null?void 0:P.length)||0)>0?"consulta":(((I=t.subscription_ids)==null?void 0:I.length)||0)>0?"suscripcion":"consulta",[h,N]=f.useState([]),[o,E]=f.useState(T),y=Array.isArray(x)?x.map(e=>({value:Number(e.id),label:`${e.name} ${e.lastname} ( C.I: ${e.identification} )`})):[],S=k.map(e=>({value:e.id,label:e.name})),F=[{value:"pendiente",label:"Pendiente"},{value:"parcial",label:"Parcial"},{value:"pagado",label:"Pagado"},{value:"incobrable",label:"Incobrable"},{value:"reembolsado",label:"Reembolsado"}],C=e=>{let n,l;o==="consulta"?(n=[...t.consultation_ids||[]],l="consultation_ids",i("subscription_ids",[])):(n=[...t.subscription_ids||[]],l="subscription_ids",i("consultation_ids",[])),n.includes(e)?n=n.filter(u=>u!==e):n.push(e),i(l,n);const g=h.filter(u=>n.includes(u.id)).reduce((u,a)=>{let m=0;if(o==="consulta"){const p=typeof a.amount=="number"?a.amount:parseFloat(String(a.amount)),A=typeof a.amount_paid=="number"?a.amount_paid:parseFloat(String(a.amount_paid||0));m=p-(A||0)||0}else{const p=a;p.subscription&&p.subscription.price!==void 0&&(m=typeof p.subscription.price=="number"?p.subscription.price:parseFloat(String(p.subscription.price)))}return u+(isNaN(m)?0:m)},0);i("amount",g)},$=e=>{const n=e?e.value:null;i("patient_id",n),i("consultation_ids",[]),i("subscription_ids",[]),i("amount",0)};f.useEffect(()=>{i("payment_type",o)},[o]),f.useEffect(()=>{const e=t.patient_id,n=new Set((t.consultation_ids||[]).map(r=>Number(r))),l=new Set((t.subscription_ids||[]).map(r=>Number(r)));if(e){const r=x.find(u=>u.id===e);let g=[];o==="consulta"?g=v.filter(a=>a.patient_id===e).filter(a=>{const m=n.has(a.id);return a.payment_status!=="pagado"||m}):o==="suscripcion"&&(g=((r==null?void 0:r.subscriptions)||[]).filter(m=>m.payment_status!=="pagado"||l.has(m.id))),N(g)}else N([])},[t.patient_id,v,o,x,t.consultation_ids,t.subscription_ids]);const M=y.find(e=>e.value===Number(t.patient_id))||null;return s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{children:[s.jsx(c,{htmlFor:"payment_method_id",children:"Método de Pago"}),s.jsx(_,{id:"payment_method_id",options:S,value:S.find(e=>e.value===t.payment_method_id)||null,onChange:e=>i("payment_method_id",e?e.value:null),isSearchable:!0,placeholder:"Selecciona un método de pago...",className:"rounded-md mt-1 block w-full"}),s.jsx(b,{message:d.payment_method_id,className:"mt-2"})]}),s.jsxs("div",{children:[s.jsx(c,{htmlFor:"status",className:"mb-2 block font-semibold text-gray-700",children:"Estado del pago"}),s.jsx(_,{id:"status",options:F,value:F.find(e=>e.value===t.status)||null,onChange:e=>i("status",(e==null?void 0:e.value)??""),isSearchable:!0,placeholder:"Select Status...",className:"rounded-md"}),s.jsx(b,{message:d.status})]})]}),s.jsxs("div",{children:[s.jsx(c,{htmlFor:"reference",children:"Referencia (opcional)"}),s.jsx(j,{id:"reference",type:"text",name:"reference",value:t.reference,className:"mt-1 block w-full",onChange:e=>i("reference",e.target.value)}),s.jsx(c,{htmlFor:"reference",className:"text-gray-500 text-sm",children:"Coloque número de referencia del pago."}),s.jsx(b,{message:d.reference,className:"mt-2"})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[y.length>0&&s.jsxs("div",{children:[s.jsx(c,{htmlFor:"patient_id",className:"mb-2 block font-semibold text-gray-700",children:"Paciente"}),s.jsx(_,{id:"patient_id",options:y,value:M,onChange:$,isSearchable:!0,placeholder:"Selecciona un paciente...",className:"rounded-md"}),s.jsx(b,{message:d.patient_id})]}),s.jsxs("div",{children:[s.jsx(c,{htmlFor:"payment_type",className:"mb-2 block font-semibold text-gray-700",children:"Tipo de Pago"}),s.jsx(_,{id:"payment_type",options:[{value:"consulta",label:"Consulta"},{value:"suscripcion",label:"Funcional"}],value:{value:o,label:o==="consulta"?"Consulta":"Funcional"},onChange:e=>{E(e==null?void 0:e.value),i("consultation_ids",[]),i("subscription_ids",[]),i("amount",0)},isSearchable:!0,placeholder:"Selecciona un tipo de pago...",className:"rounded-md"})]})]}),o==="consulta"&&s.jsxs("div",{className:"mb-4",children:[s.jsx(c,{className:"mb-2 block font-semibold text-gray-700",children:"Consultas pendientes a pagar"}),h.length>0?s.jsx(R,{pendingConsultations:h,data:t,toggleConsultationSelection:C,initialSelectedConsultationIds:w}):s.jsx("div",{className:"text-gray-500 text-sm mt-2",children:"No hay consultas pendientes de pago para este paciente."}),s.jsx(b,{message:d.consultation_ids})]}),o==="suscripcion"&&s.jsxs("div",{className:"mb-4",children:[s.jsx(c,{className:"mb-2 block font-semibold text-gray-700",children:"Funcionales pendientes a pagar"}),h.length>0?s.jsx(L,{pendingSubscriptions:h,data:t,toggleSubscriptionSelection:C}):s.jsx("div",{className:"text-gray-500 text-sm mt-2",children:"No hay Funcionales pendientes de pago para este paciente."}),s.jsx(b,{message:d.subscription_ids})]}),s.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:["Deuda total seleccionada: $",h.filter(e=>o==="consulta"?t.consultation_ids.includes(e.id):t.subscription_ids.includes(e.id)).reduce((e,n)=>{var l;if(o==="consulta"){const r=typeof n.amount=="number"?n.amount:parseFloat(String(n.amount)),g=typeof n.amount_paid=="number"?n.amount_paid:parseFloat(String(n.amount_paid||0));return e+(r-(g||0)||0)}else return e+(((l=n.subscription)==null?void 0:l.price)??0)},0).toFixed(2)]}),s.jsxs("div",{children:[s.jsx(c,{htmlFor:"amount",children:"Monto a pagar"}),s.jsx(j,{id:"amount",type:"number",name:"amount",value:t.amount,min:0,step:"0.01",className:"mt-1 block w-full",onChange:e=>{const n=e.target.value,l=n===""?0:parseFloat(n);!isNaN(l)&&l>=0&&i("amount",l)}}),s.jsx(b,{message:d.amount,className:"mt-2"})]}),s.jsxs("div",{children:[s.jsx(c,{htmlFor:"notes",children:"Notas (opcional)"}),s.jsx(j,{id:"notes",type:"text",name:"notes",value:t.notes,className:"mt-1 block w-full",onChange:e=>i("notes",e.target.value)}),s.jsx(c,{htmlFor:"notes",className:"text-gray-500 text-sm",children:"Notas sobre el pago."}),s.jsx(b,{message:d.notes,className:"mt-2"})]})]})}export{Z as default};
